# 财务数据处理 - 分阶段执行指令

## 重要说明

**必须分两个阶段执行**：
1. **阶段1**：清理原始表格的表头和干扰信息
2. **阶段2**：整合清理后的消费记录

## 阶段1：数据清理

### 执行指令

```
请阅读"财务数据处理配置.yaml"文件中的stage1_data_cleaning规则，清理当前目录中的原始数据文件的表头和无关信息。
```

### 处理内容
- **招行CSV文件**：删除表头说明行、底部统计行，提取纯消费记录
- **微信CSV文件**：删除表头行、导出信息行，排除转账和红包

### 预期输出
- `招行纯消费记录.csv`
- `微信纯消费记录.csv`

### 验证要点
- [ ] 表头说明文字已完全清除
- [ ] 只包含真实消费交易
- [ ] 列名已标准化
- [ ] 数据格式整齐

---

## 阶段2：数据整合

### 执行指令

```
请阅读"财务数据处理配置.yaml"文件中的stage2_data_integration规则，整合已清理的消费记录文件。
```

### 处理内容
- 合并招行和微信的纯消费记录
- 保持时间精度差异（微信精确到秒，招行仅日期）
- 检测重复记录
- 添加数据来源标记

### 预期输出
- `完整消费记录.csv`

### 验证要点
- [ ] 微信数据保持精确时间戳
- [ ] 招行数据仅有日期（无虚假时间）
- [ ] 每条记录有数据来源标记
- [ ] 无重复记录

## 配置文件核心要点
- **分阶段处理**：先清理表头，再整合数据
- **时间处理**：微信保持精确时间戳，银行仅保留日期  
- **表头清理**：两个平台都需要清理表头干扰信息
- **数据来源**：每条记录标明来源平台

## 为什么要分阶段？

### 原始数据问题
- **招行CSV**：PDF转换后表头混乱、底部说明干扰
- **微信CSV**：表头行、导出信息、交易类型混合

### 分阶段优势
- **错误定位精确**：问题出现在哪个阶段很清楚
- **质量控制严格**：每阶段都可以独立验证
- **调试更容易**：出错时只需重做单个阶段
- **用户可控性强**：可以检查中间结果

## 故障排除

### 阶段1常见问题
- **表头未完全清除**：检查清理规则是否覆盖所有表头行
- **数据丢失**：确认排除规则没有误删真实消费
- **格式不一致**：检查列名是否标准化

### 阶段2常见问题  
- **时间格式错误**：确保银行数据没有添加虚假时间
- **重复记录**：检查重复检测逻辑
- **来源标记缺失**：确认每条记录都有数据来源字段